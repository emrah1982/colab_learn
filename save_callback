# Google Drive'a baÄŸlanma ve eÄŸitim kaydetme iÃ§in kodu github_connect.py dosyanÄ±za ekleyin
from google.colab import drive
import os
import shutil
import time
from ultralytics.engine.callbacks.base import Callback

# 1. Ã–nce Drive'Ä± monte edin (bu kod sadece bir kez Ã§alÄ±ÅŸtÄ±rÄ±lmalÄ±)
drive.mount('/content/drive')

# 2. Google Drive'da dosyalarÄ±n kaydedileceÄŸi klasÃ¶rÃ¼ belirleyin
DRIVE_SAVE_PATH = '/content/drive/MyDrive/yolo11_egitim_kayitlari'
os.makedirs(DRIVE_SAVE_PATH, exist_ok=True)

# 3. EÄŸitim dosyalarÄ±nÄ± Google Drive'a kaydeden callback sÄ±nÄ±fÄ±
class SaveToDriveCallback(Callback):
    def __init__(self, save_interval=20, save_path=DRIVE_SAVE_PATH):
        self.save_interval = save_interval  # KaÃ§ epoch'ta bir kaydedileceÄŸi
        self.save_path = save_path
        self.last_saved = 0
        
    def _save_to_drive(self, trainer):
        """EÄŸitim dosyalarÄ±nÄ± Drive'a kaydet"""
        # EÄŸitim dizinini belirle
        run_dir = trainer.args.save_dir
        exp_path = os.path.dirname(run_dir) if run_dir.endswith('weights') else run_dir
        
        # Hedef klasÃ¶r adÄ±nÄ± oluÅŸtur (timestamp ve epoch bilgisi ile)
        timestamp = time.strftime("%Y%m%d_%H%M%S")
        target_dir = os.path.join(self.save_path, f"egitim_{timestamp}_epoch{trainer.epoch}")
        os.makedirs(target_dir, exist_ok=True)
        
        # AÄŸÄ±rlÄ±k dosyalarÄ±nÄ± kopyala
        weights_dir = os.path.join(exp_path, 'weights')
        if os.path.exists(weights_dir):
            os.makedirs(os.path.join(target_dir, 'weights'), exist_ok=True)
            for model_file in ['last.pt', 'best.pt']:
                src_file = os.path.join(weights_dir, model_file)
                if os.path.exists(src_file):
                    shutil.copy2(src_file, os.path.join(target_dir, 'weights', model_file))
                    print(f"âœ… {model_file} dosyasÄ± Drive'a kopyalandÄ±.")
        
        # YapÄ±landÄ±rma dosyalarÄ±nÄ± kopyala
        for config_file in ['args.yaml', 'hyp.yaml']:
            src_file = os.path.join(exp_path, config_file)
            if os.path.exists(src_file):
                shutil.copy2(src_file, os.path.join(target_dir, config_file))
                print(f"âœ… {config_file} dosyasÄ± Drive'a kopyalandÄ±.")
        
        print(f"ğŸ“ EÄŸitim dosyalarÄ± {target_dir} dizinine kaydedildi.")
        self.last_saved = trainer.epoch
    
    def on_train_epoch_end(self, trainer):
        """Her epoch sonunda kontrol et ve belirli aralÄ±klarla kaydet"""
        if trainer.epoch > 0 and trainer.epoch % self.save_interval == 0 and trainer.epoch != self.last_saved:
            print(f"\nâ±ï¸ Epoch {trainer.epoch} tamamlandÄ±. Drive'a kaydediliyor...")
            self._save_to_drive(trainer)
    
    def on_train_end(self, trainer):
        """EÄŸitim tamamlandÄ±ÄŸÄ±nda kaydet"""
        print("\nğŸ EÄŸitim tamamlandÄ±. Son durum Drive'a kaydediliyor...")
        self._save_to_drive(trainer)
    
    def on_exception(self, trainer, exception):
        """EÄŸitim sÄ±rasÄ±nda hata oluÅŸursa son durumu kaydet"""
        print(f"\nâŒ EÄŸitimde hata oluÅŸtu: {exception}\nMevcut durum Drive'a kaydediliyor...")
        self._save_to_drive(trainer)

# 4. main.py dosyanÄ±zÄ± bu callback'i kullanacak ÅŸekilde gÃ¼ncelleyin
# main.py dosyasÄ±na eklenecek kÄ±sÄ±m:
